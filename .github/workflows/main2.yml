name: Use Credentials JSON

on:
  workflow_dispatch:

jobs:
  iterate-creds:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Loop through credentials and set output
        id: creds
        run: |
          echo "Reading from GitHub Environment Variable..."
          i=0
          for cred in $(echo "$CREDENTIALS" | jq -c '.[]'); do
            USER=$(echo $cred | jq -r '.username')
            PASS=$(echo $cred | jq -r '.password')
            echo "Processing user: $USER"
            echo "user_$i=$USER" >> $GITHUB_OUTPUT
            echo "pass_$i=$PASS" >> $GITHUB_OUTPUT
            i=$((i+1))
          done
          echo "count=$i" >> $GITHUB_OUTPUT
        env:
          CREDENTIALS: ${{ vars.CREDENTIALS }}

      - name: Print credentials in next step
        run: |
          echo "We got ${{ steps.creds.outputs.count }} credentials"
          for i in $(seq 0 $(( ${{ steps.creds.outputs.count }} - 1 ))); do
            USER_KEY="user_$i"
            PASS_KEY="pass_$i"
            USER="${{ steps.creds.outputs[user_0] }}"
            PASS="${{ steps.creds.outputs[pass_0] }}"
            # Instead of hardcoding index 0, use eval trick:
            USER=$(eval echo "\${{ steps.creds.outputs.user_$i }}")
            PASS=$(eval echo "\${{ steps.creds.outputs.pass_$i }}")
            echo "Credential $i -> USER=$USER , PASS=$PASS"
          done

